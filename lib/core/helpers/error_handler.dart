import 'dart:io';
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:cloud_firestore/cloud_firestore.dart';

/// Ù…Ø³Ø§Ø¹Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¨Ø´ÙƒÙ„ Ø´Ø§Ù…Ù„
class ErrorHandler {
  /// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø®Ø·Ø£ ÙˆØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  static void handle(
    dynamic error, {
    String? context,
    bool showSnackbar = true,
    VoidCallback? onRetry,
  }) {
    final message = getUserFriendlyMessage(error, context: context);

    // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø®Ø·Ø£ Ù„Ù„ØªØ·ÙˆÙŠØ±
    _logError(error, context);

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (showSnackbar) {
      Get.snackbar(
        'Ø®Ø·Ø£',
        message,
        snackPosition: SnackPosition.TOP,
        backgroundColor: const Color(0xFFFF3B30),
        colorText: Colors.white,
        duration: const Duration(seconds: 4),
        margin: const EdgeInsets.all(16),
        borderRadius: 12,
        icon: const Icon(Icons.error_outline, color: Colors.white),
        mainButton: onRetry != null
            ? TextButton(
                onPressed: onRetry,
                child: const Text(
                  'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©',
                  style: TextStyle(color: Colors.white),
                ),
              )
            : null,
      );
    }
  }

  /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ù…ÙÙ‡ÙˆÙ…Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  static String getUserFriendlyMessage(dynamic error, {String? context}) {
    // Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ©
    if (error is SocketException) {
      return 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
    }

    if (error is HttpException) {
      return 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.';
    }

    // Ø£Ø®Ø·Ø§Ø¡ Firebase
    if (error is FirebaseException) {
      return _getFirebaseErrorMessage(error);
    }

    // Ø£Ø®Ø·Ø§Ø¡ Firestore
    if (error.toString().contains('permission-denied')) {
      return 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰.';
    }

    if (error.toString().contains('unavailable')) {
      return 'Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.';
    }

    if (error.toString().contains('deadline-exceeded')) {
      return 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.';
    }

    // Ø£Ø®Ø·Ø§Ø¡ API Keys
    if (error.toString().contains('API key') ||
        error.toString().contains('401') ||
        error.toString().contains('Unauthorized')) {
      return 'Ù…ÙØªØ§Ø­ API ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.';
    }

    // Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø­ØµØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©
    if (error.toString().contains('quota') ||
        error.toString().contains('limit exceeded')) {
      return 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø£Ùˆ ØªØ±Ù‚ÙŠØ© Ø§Ø´ØªØ±Ø§ÙƒÙƒ.';
    }

    // Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    if (error.toString().contains('invalid') ||
        error.toString().contains('validation')) {
      return 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
    }

    // Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹
    if (error.toString().contains('payment') ||
        error.toString().contains('transaction')) {
      return 'ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹. ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
    }

    // Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù…Ø¹ Ø§Ù„Ø³ÙŠØ§Ù‚
    if (context != null) {
      return 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ $context. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.';
    }

    return 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.';
  }

  /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Firebase Ù…Ø­Ø¯Ø¯Ø©
  static String _getFirebaseErrorMessage(FirebaseException error) {
    switch (error.code) {
      // Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
      case 'invalid-email':
        return 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­.';
      case 'user-disabled':
        return 'ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.';
      case 'user-not-found':
        return 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.';
      case 'wrong-password':
        return 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
      case 'email-already-in-use':
        return 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.';
      case 'weak-password':
        return 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©. Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£Ù‚ÙˆÙ‰.';
      case 'operation-not-allowed':
        return 'Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­Ø©. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.';
      case 'too-many-requests':
        return 'ØªÙ… Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¨Ø³Ø¨Ø¨ ÙƒØ«Ø±Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©.';

      // Ø£Ø®Ø·Ø§Ø¡ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
      case 'invalid-phone-number':
        return 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­.';
      case 'invalid-verification-code':
        return 'Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­.';
      case 'invalid-verification-id':
        return 'Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚. Ø§Ø·Ù„Ø¨ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯.';

      // Ø£Ø®Ø·Ø§Ø¡ Firestore
      case 'permission-denied':
        return 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰.';
      case 'not-found':
        return 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.';
      case 'already-exists':
        return 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„.';
      case 'resource-exhausted':
        return 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.';
      case 'cancelled':
        return 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.';
      case 'data-loss':
        return 'Ø­Ø¯Ø« ÙÙ‚Ø¯Ø§Ù† ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
      case 'unauthenticated':
        return 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.';
      case 'unavailable':
        return 'Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.';

      default:
        return 'Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message ?? "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}';
    }
  }

  /// Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø®Ø·Ø£ Ù„Ù„ØªØ·ÙˆÙŠØ±
  static void _logError(dynamic error, String? context) {
    print('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    print('âŒ ERROR OCCURRED');
    if (context != null) print('ğŸ“ Context: $context');
    print('ğŸ”´ Error: $error');
    if (error is Error) {
      print('ğŸ“š Stack Trace:\n${error.stackTrace}');
    }
    print('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  }

  /// Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù…Ù„ÙŠØ© Ù…Ø¹ Ø¹Ø¯Ø¯ Ù…Ø­Ø¯Ø¯ Ù…Ù† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
  static Future<T?> retry<T>(
    Future<T> Function() operation, {
    int maxAttempts = 3,
    Duration delay = const Duration(seconds: 2),
    String? context,
  }) async {
    int attempts = 0;

    while (attempts < maxAttempts) {
      try {
        attempts++;
        return await operation();
      } catch (e) {
        if (attempts >= maxAttempts) {
          handle(e, context: context);
          return null;
        }

        print('âš ï¸ Attempt $attempts failed. Retrying in ${delay.inSeconds}s...');
        await Future.delayed(delay);
      }
    }

    return null;
  }

  /// Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù…Ù„ÙŠØ© Ù…Ø¹ ØªØ£Ø®ÙŠØ± ØªØµØ§Ø¹Ø¯ÙŠ
  static Future<T?> retryWithBackoff<T>(
    Future<T> Function() operation, {
    int maxAttempts = 3,
    Duration initialDelay = const Duration(seconds: 1),
    double backoffMultiplier = 2.0,
    String? context,
  }) async {
    int attempts = 0;
    Duration currentDelay = initialDelay;

    while (attempts < maxAttempts) {
      try {
        attempts++;
        return await operation();
      } catch (e) {
        if (attempts >= maxAttempts) {
          handle(e, context: context);
          return null;
        }

        print('âš ï¸ Attempt $attempts failed. Retrying in ${currentDelay.inSeconds}s...');
        await Future.delayed(currentDelay);
        currentDelay *= backoffMultiplier;
      }
    }

    return null;
  }

  /// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ async/await Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
  static Future<T?> tryCatch<T>(
    Future<T> Function() operation, {
    String? context,
    T? defaultValue,
    bool showError = true,
  }) async {
    try {
      return await operation();
    } catch (e) {
      if (showError) {
        handle(e, context: context);
      }
      return defaultValue;
    }
  }

  /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
  static Future<bool> checkInternetConnection() async {
    try {
      final result = await InternetAddress.lookup('google.com');
      return result.isNotEmpty && result[0].rawAddress.isNotEmpty;
    } on SocketException catch (_) {
      return false;
    }
  }

  /// Ø¹Ø±Ø¶ Ø­ÙˆØ§Ø± Ø®Ø·Ø£ Ù…Ø®ØµØµ
  static Future<void> showErrorDialog({
    required String title,
    required String message,
    VoidCallback? onRetry,
    VoidCallback? onCancel,
  }) async {
    return Get.dialog(
      AlertDialog(
        backgroundColor: const Color(0xFF1A1A1A),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        title: Row(
          children: [
            const Icon(Icons.error_outline, color: Color(0xFFFF3B30), size: 28),
            const SizedBox(width: 12),
            Expanded(
              child: Text(
                title,
                style: const TextStyle(
                  color: Colors.white,
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ],
        ),
        content: Text(
          message,
          style: const TextStyle(
            color: Color(0xFFB0B0B0),
            fontSize: 16,
          ),
        ),
        actions: [
          if (onCancel != null)
            TextButton(
              onPressed: () {
                Get.back();
                onCancel();
              },
              child: const Text('Ø¥Ù„ØºØ§Ø¡'),
            ),
          if (onRetry != null)
            ElevatedButton(
              onPressed: () {
                Get.back();
                onRetry();
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF00D9FF),
                foregroundColor: const Color(0xFF0A0A0A),
              ),
              child: const Text('Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©'),
            ),
          if (onRetry == null && onCancel == null)
            ElevatedButton(
              onPressed: () => Get.back(),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF00D9FF),
                foregroundColor: const Color(0xFF0A0A0A),
              ),
              child: const Text('Ø­Ø³Ù†Ø§Ù‹'),
            ),
        ],
      ),
      barrierDismissible: false,
    );
  }

  /// Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
  static void showSuccess(String message) {
    Get.snackbar(
      'Ù†Ø¬Ø­',
      message,
      snackPosition: SnackPosition.TOP,
      backgroundColor: const Color(0xFF34C759),
      colorText: Colors.white,
      duration: const Duration(seconds: 3),
      margin: const EdgeInsets.all(16),
      borderRadius: 12,
      icon: const Icon(Icons.check_circle_outline, color: Colors.white),
    );
  }

  /// Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ±
  static void showWarning(String message) {
    Get.snackbar(
      'ØªØ­Ø°ÙŠØ±',
      message,
      snackPosition: SnackPosition.TOP,
      backgroundColor: const Color(0xFFFF9500),
      colorText: Colors.white,
      duration: const Duration(seconds: 3),
      margin: const EdgeInsets.all(16),
      borderRadius: 12,
      icon: const Icon(Icons.warning_amber_outlined, color: Colors.white),
    );
  }

  /// Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
  static void showInfo(String message) {
    Get.snackbar(
      'Ù…Ø¹Ù„ÙˆÙ…Ø©',
      message,
      snackPosition: SnackPosition.TOP,
      backgroundColor: const Color(0xFF007AFF),
      colorText: Colors.white,
      duration: const Duration(seconds: 3),
      margin: const EdgeInsets.all(16),
      borderRadius: 12,
      icon: const Icon(Icons.info_outline, color: Colors.white),
    );
  }
}
